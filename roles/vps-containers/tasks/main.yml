- name: install the python postgres adapter
  package:
    name: python-psycopg2

- name: create docker network
  docker_network:
    name: containers

- name: create volume for postgres
  docker_volume:
    name: postgres_data

- name: create postgres container
  docker_container:
    name: postgres
    image: "postgres:alpine"
    ports:
      - "5432:5432"
    env:
      POSTGRES_USER: "{{ postgres_user_root }}"
      POSTGRES_PASSWORD: "{{ postgres_password_root }}"
    volumes:
      - "postgres_data:/var/lib/postgresql/data"
    networks:
      - name: containers
    networks_cli_compatible: yes
    restart_policy: "unless-stopped"

- name: wait for postgres to start
  shell: /usr/bin/pg_isready -U "{{ postgres_user_root }}" -h "127.0.0.1" -p 5432
  register: result
  until: result.rc == 0
  retries: 12
  delay: 10

- name: create nextcloud postgresql user
  postgresql_user:
    name: "{{ postgres_user_nextcloud }}"
    password: "{{ postgres_password_nextcloud }}"
    role_attr_flags: NOSUPERUSER
    login_user: "{{ postgres_user_root }}"
    login_password: "{{ postgres_password_root }}"
    login_host: "127.0.0.1"

- name: create nextcloud database
  postgresql_db:
    name: "{{ postgres_db_nextcloud }}"
    owner: "{{ postgres_user_nextcloud }}"
    encoding: UTF-8
    login_user: "{{ postgres_user_root }}"
    login_password: "{{ postgres_password_root }}"
    login_host: "127.0.0.1"

- name: create volumes for nextcloud
  docker_volume:
    name: "{{ item }}"
  loop:
    - nextcloud_apps
    - nextcloud_config
    - nextcloud_data

- name: create nextcloud container
  docker_container:
    name: nextcloud
    image: "nextcloud:latest"
    ports:
      - "8000:80"
    env:
      NEXTCLOUD_ADMIN_USER: "{{ nextcloud_user_admin }}"
      NEXTCLOUD_ADMIN_PASSWORD: "{{ nextcloud_password_admin }}"
      NEXTCLOUD_TRUSTED_DOMAINS: "{{ nextcloud_trusted_domains }}"
      POSTGRES_DB: "{{ postgres_db_nextcloud }}"
      POSTGRES_USER: "{{ postgres_user_nextcloud }}"
      POSTGRES_PASSWORD: "{{ postgres_password_nextcloud }}"
      POSTGRES_HOST: "postgres"
    volumes:
      - "nextcloud_apps:/var/www/html/custom_apps"
      - "nextcloud_config:/var/www/html/config"
      - "nextcloud_data:/var/www/html/data"
    networks:
      - name: containers
    networks_cli_compatible: yes
    restart_policy: "unless-stopped"

- name: install nginx
  package:
    name: nginx

- name: start/enable nginx
  service:
    name: nginx
    state: started
    enabled: yes

- name: install certbot
  package:
    name:
      - certbot
      - certbot-nginx

- name: open ports for nginx
  ufw:
    rule: allow
    port: "{{ item | int }}"
  loop:
    - 80
    - 443
