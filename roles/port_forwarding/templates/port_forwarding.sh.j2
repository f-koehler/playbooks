#!/bin/bash
set -euf -o pipefail

INTERFACE=eth0
SOURCE_PORT=80
DESTINATION_IP=192.168.0.109
DESTINATION_PORT=5000

{% set interface = port_forwarding["interface"] %}
{% for forward in port_forwarding["forwards"] %}
    {% set local = forward["local"] %}
    {% set remote = forward["remote"] %}
    {% set address = forward["address"] %}

    iptables -A FORWARD -i {{ interface }} -j ACCEPT
    iptables -A FORWARD -o {{ interface }} -j ACCEPT
    iptables -t nat -A POSTROUTING -o {{ interface }} -j MASQUERADE

    iptables -t nat -A PREROUTING -i {{ interface }} -p tcp --dport {{ local }} -j DNAT --to {{ address }}:{{ remote }}
    iptables -A FORWARD -i {{ interface }} -p tcp --dport {{ local }} -d {{ address }} -j ACCEPT
{% endfor %}
