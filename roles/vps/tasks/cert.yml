- name: install packages
  ansible.builtin.package:
    name: "{{ item }}"
  loop:
    - certbot
    - certbot-dns-cloudflare

- name: create certbot config dir
  ansible.builtin.file:
    path: /etc/certbot
    owner: root
    group: root
    mode: 0700

- name: configure certbot cloudflare plugin
  ansible.builtin.template:
    src: cloudflare.ini
    dest: /etc/certbot/cloudflare.ini
    owner: root
    group: root
    mode: 0600

- name: run certbot
  ansible.builtin.command: >
    certbot
    certonly
    --expand
    --keep
    --non-interactive
    --agree-tos
    -m
    {{ letsencrypt_email }}
    --dns-cloudflare
    --dns-cloudflare-credentials
    /etc/certbot/cloudflare.ini
    -d {{domain}}
    {{subdomains|map('regex_replace', '^(.*)$', '-d \1\.'+domain)|join(' ')}}
  notify:
    - restart nginx
    - restart nginx (blog)
